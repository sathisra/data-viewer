<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aruvadai Data Viewer</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fa;
      padding: 20px;
      color: #333;
    }
    
    .container { max-width: 1400px; margin: 0 auto; }
    
    header {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      color: white;
      padding: 20px 28px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    header h1 { font-size: 1.4rem; font-weight: 600; }
    
    .header-actions { display: flex; gap: 10px; align-items: center; }
    
    .btn {
      background: rgba(255,255,255,0.2);
      border: none;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    
    .btn:hover { background: rgba(255,255,255,0.3); }
    
    select.table-select {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      font-size: 0.9rem;
      background: white;
      min-width: 180px;
    }
    
    .table-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    
    .toolbar {
      padding: 14px 16px;
      border-bottom: 1px solid #eee;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .toolbar input {
      padding: 9px 14px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9rem;
      width: 250px;
    }
    
    .toolbar input:focus {
      outline: none;
      border-color: #6366f1;
    }
    
    .record-count {
      margin-left: auto;
      color: #666;
      font-size: 0.85rem;
    }
    
    .table-scroll { overflow-x: auto; }
    
    table { width: 100%; border-collapse: collapse; }
    
    th {
      background: #f8f9fc;
      padding: 11px 14px;
      text-align: left;
      font-weight: 600;
      font-size: 0.8rem;
      color: #555;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #eee;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }
    
    th:hover { background: #eef0f5; }
    th .sort-icon { margin-left: 4px; opacity: 0.4; }
    th.sorted .sort-icon { opacity: 1; }
    
    td {
      padding: 12px 14px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 0.9rem;
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    tr:hover { background: #f8f9fc; }
    
    .loading, .error, .empty {
      text-align: center;
      padding: 60px;
      color: #666;
    }
    
    .error { color: #dc2626; }
    
    .loading-spinner {
      width: 36px;
      height: 36px;
      border: 3px solid #eee;
      border-top-color: #6366f1;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 14px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .no-tables {
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
    }
    
    .no-tables code {
      background: #f1f1f1;
      padding: 2px 6px;
      border-radius: 4px;
    }

    @media (max-width: 640px) {
      header { flex-direction: column; align-items: stretch; }
      .toolbar { flex-direction: column; }
      .toolbar input { width: 100%; }
      .record-count { margin-left: 0; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1 id="page-title">ðŸ“Š Data Viewer</h1>
      <div class="header-actions">
        <select class="table-select" id="table-select" onchange="switchTable()">
          <option value="">-- Select Table --</option>
        </select>
        <button class="btn" onclick="loadData()">â†» Refresh</button>
        <button class="btn" onclick="exportCSV()">â¬‡ Export CSV</button>
      </div>
    </header>
    
    <div class="table-container">
      <div class="toolbar">
        <input type="text" id="search" placeholder="Search..." onkeyup="filterTable()">
        <span class="record-count" id="record-count"></span>
      </div>
      <div class="table-scroll">
        <div id="table-wrapper">
          <div class="empty">Select a table above to view data</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ============== CONFIGURATION ==============
    const CONFIG = {
      // Your Directus URL
      directusUrl: 'https://cms.aruvadaiorganic.com',
      
      // Tables to expose publicly (must have Public read access in Directus)
      tables: [
        'customer_feedback',
        'cust_addr',
        // Add more tables here as needed:
        // 'orders',
        // 'products',
      ],
      
      // Columns to hide globally
      hiddenColumns: ['user_created', 'user_updated', 'date_created', 'date_updated'],
      
      // Per-table hidden columns (optional)
      tableHiddenColumns: {
        // 'customer_feedback': ['internal_notes'],
        // 'orders': ['cost_price'],
      },
      
      // Friendly names for columns
      columnLabels: {
        'id': 'ID',
        'customer_name': 'Customer Name',
        'submitted_at': 'Submitted',
        'created_at': 'Created',
        'updated_at': 'Updated',
      },
      
      // Friendly names for tables
      tableLabels: {
        'customer_feedback': 'Customer Feedback',
        'cust_addr': 'Customer Addresses',
      }
    };
    // ============================================

    let allData = [];
    let currentTable = '';
    let sortColumn = '';
    let sortAsc = true;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      populateTableSelect();
      
      // Check URL param for table
      const urlParams = new URLSearchParams(window.location.search);
      const tableParam = urlParams.get('table');
      if (tableParam && CONFIG.tables.includes(tableParam)) {
        document.getElementById('table-select').value = tableParam;
        switchTable();
      }
    });

    function populateTableSelect() {
      const select = document.getElementById('table-select');
      CONFIG.tables.forEach(table => {
        const option = document.createElement('option');
        option.value = table;
        option.textContent = CONFIG.tableLabels[table] || formatColumnName(table);
        select.appendChild(option);
      });
    }

    function switchTable() {
      const select = document.getElementById('table-select');
      currentTable = select.value;
      
      if (!currentTable) {
        document.getElementById('table-wrapper').innerHTML = '<div class="empty">Select a table above</div>';
        document.getElementById('record-count').textContent = '';
        return;
      }
      
      // Update URL without reload
      const url = new URL(window.location);
      url.searchParams.set('table', currentTable);
      window.history.replaceState({}, '', url);
      
      // Update title
      const label = CONFIG.tableLabels[currentTable] || formatColumnName(currentTable);
      document.getElementById('page-title').textContent = 'ðŸ“Š ' + label;
      
      loadData();
    }

    async function loadData() {
      if (!currentTable) return;
      
      const wrapper = document.getElementById('table-wrapper');
      wrapper.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading...</div>';
      
      try {
        const response = await fetch(`${CONFIG.directusUrl}/items/${currentTable}?limit=-1`);
        
        if (!response.ok) {
          if (response.status === 403 || response.status === 401) {
            throw new Error('Access denied. Enable Public read access in Directus for this table.');
          }
          throw new Error(`HTTP ${response.status}`);
        }
        
        const result = await response.json();
        allData = result.data || [];
        
        document.getElementById('record-count').textContent = `${allData.length} records`;
        document.getElementById('search').value = '';
        sortColumn = '';
        
        renderTable(allData);
        
      } catch (error) {
        wrapper.innerHTML = `<div class="error"><strong>Error:</strong> ${error.message}</div>`;
        document.getElementById('record-count').textContent = '';
      }
    }

    function renderTable(data) {
      const wrapper = document.getElementById('table-wrapper');
      
      if (data.length === 0) {
        wrapper.innerHTML = '<div class="empty">No data found</div>';
        return;
      }
      
      const hiddenCols = [
        ...CONFIG.hiddenColumns,
        ...(CONFIG.tableHiddenColumns[currentTable] || [])
      ];
      
      const columns = Object.keys(data[0]).filter(col => !hiddenCols.includes(col));
      
      let html = '<table><thead><tr>';
      columns.forEach(col => {
        const label = CONFIG.columnLabels[col] || formatColumnName(col);
        const sortedClass = sortColumn === col ? 'sorted' : '';
        const arrow = sortColumn === col ? (sortAsc ? 'â†‘' : 'â†“') : 'â†•';
        html += `<th class="${sortedClass}" onclick="sortBy('${col}')">${label} <span class="sort-icon">${arrow}</span></th>`;
      });
      html += '</tr></thead><tbody>';
      
      data.forEach(row => {
        html += '<tr>';
        columns.forEach(col => {
          let val = row[col];
          val = formatValue(val, col);
          html += `<td title="${String(val).replace(/"/g, '&quot;')}">${val}</td>`;
        });
        html += '</tr>';
      });
      
      html += '</tbody></table>';
      wrapper.innerHTML = html;
    }

    function formatValue(val, col) {
      if (val === null || val === undefined) return '-';
      
      // Format dates
      if (typeof val === 'string' && (col.includes('date') || col.includes('_at') || col.includes('created') || col.includes('updated'))) {
        const d = new Date(val);
        if (!isNaN(d)) {
          return d.toLocaleDateString('en-IN', { year: 'numeric', month: 'short', day: 'numeric' });
        }
      }
      
      // Format booleans
      if (typeof val === 'boolean') return val ? 'âœ“ Yes' : 'âœ— No';
      
      // Format objects/arrays
      if (typeof val === 'object') return JSON.stringify(val);
      
      return val;
    }

    function formatColumnName(col) {
      return col.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    }

    function filterTable() {
      const search = document.getElementById('search').value.toLowerCase();
      const filtered = allData.filter(row =>
        Object.values(row).some(v => String(v).toLowerCase().includes(search))
      );
      document.getElementById('record-count').textContent = `${filtered.length} of ${allData.length} records`;
      renderTable(filtered);
    }

    function sortBy(col) {
      if (sortColumn === col) {
        sortAsc = !sortAsc;
      } else {
        sortColumn = col;
        sortAsc = true;
      }
      
      allData.sort((a, b) => {
        let valA = a[col], valB = b[col];
        if (valA === null) return 1;
        if (valB === null) return -1;
        if (typeof valA === 'string') valA = valA.toLowerCase();
        if (typeof valB === 'string') valB = valB.toLowerCase();
        if (valA < valB) return sortAsc ? -1 : 1;
        if (valA > valB) return sortAsc ? 1 : -1;
        return 0;
      });
      
      renderTable(allData);
    }

    function exportCSV() {
      if (!allData.length) return alert('No data to export');
      
      const hiddenCols = [...CONFIG.hiddenColumns, ...(CONFIG.tableHiddenColumns[currentTable] || [])];
      const columns = Object.keys(allData[0]).filter(c => !hiddenCols.includes(c));
      
      let csv = columns.join(',') + '\n';
      allData.forEach(row => {
        csv += columns.map(c => {
          let v = row[c];
          if (v === null || v === undefined) return '';
          v = String(v).replace(/"/g, '""');
          return `"${v}"`;
        }).join(',') + '\n';
      });
      
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${currentTable}_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    }
  </script>
</body>
</html>
